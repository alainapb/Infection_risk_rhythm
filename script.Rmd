---
title: "script"
author: "APB"
date: "4/30/2021"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(patchwork)

knitr::opts_chunk$set(echo = TRUE)
```


#Load/Clean data
```{r load_data, include=FALSE}
feed_data<-read.csv("data/feeding_data_3.28.21.csv", header=T)

po<-read.csv("data/4_Day_PO.csv", header = T) #Corrected_Change is the Active PO per sample (~8 ind. per sample)

po_correct<- # sample number is arbitrary
  read_csv("data/PO_biodare_sample_correction.csv") %>%
  pivot_longer(cols = 2:5, names_sep = "_", 
               names_to = c(NA,"sample"), values_to = "PO")

growth<-read.csv("data/growth_data_3.28.21.csv", header=T)

life<-read.csv("data/life_data_3.28.21.csv", header =T)

```


#Calculate feeding rates
```{r animal_feed_rates, include = FALSE}
#calculate the mean of the controls for each plate
summary_data <- feed_data %>%
  group_by(Plate_Control) %>%
  mutate(control_mean = mean(Control_Flour_Reading, na.rm = T)) %>%
  select(Plate_Control, control_mean) %>%
  distinct() %>% as.data.frame()

#remove extra row
summary_data  <- summary_data[!(summary_data$Plate_Control == ""),]

#match control mean with plate treatment
map = setNames(summary_data$control_mean,summary_data$Plate_Control)
feed_data$control_mean <- map[as.character(feed_data$Plate_Treatment)]

#volume, mL
v = 10

#time, hours
t = 9

##difference in feeding compared to control
k=feed_data$control_mean/feed_data$Flourometry_Reading

##calculate feeding rate (Sarnelle and Wilson)
feed_data$fr_sw <- log(k) * (v/t)

#calculate mean feeding rate per animal (keep rate > 0)
animal_mean <- feed_data %>%
  #keep fr_sw values > 0
  #filter(fr_sw > 0) %>% #this removes 64 animals...
  #group based on these variables
  group_by(Time_treatment, Age, Animal, Exposed.Control) %>%
  #means based on groups above
  summarise(fr_sw = mean(fr_sw, na.rm=TRUE)) 

```


#Merge dataframes
```{r combine_dataframes, include=FALSE}
#combine feeding rates with life history data 
merge(animal_mean, life, by=c("Age", "Time_treatment", "Animal", "Exposed.Control"), keep=TRUE) %>%
  mutate(id = paste(Age,
                    Time_treatment,
                    Animal,
                    Exposed.Control, 
                    sep = "_")) %>%
           as.data.frame()->all.data


#create id for growth data 
growth %>%
  mutate(id = paste(Age,
                    Time_treatment,
                    Animal,
                    Exposed.Control, 
                    sep = "_")) %>%
           as.data.frame()->growth
# join growth data to feeding rate and life history data
all.data <- inner_join(all.data, growth, by = c("Age", "Time_treatment", "Animal", "Exposed.Control", "id"))
```

#Exploratory Plots
```{r feeding_rate_plot, echo=FALSE}
all.data %>%
  filter(Sex == "F")%>%
  ggplot()+
  geom_boxplot(aes(x=as.factor(Age), y=fr_sw, color=Time_treatment))+
  scale_color_manual(values=c("goldenrod2", "darkblue"))+
  facet_grid(.~Exposed.Control)+
  theme_bw()

all.data %>%
  filter(Sex == "F")%>%
  ggplot()+
  geom_jitter(aes(x=Time_treatment, y=fr_sw, color=Exposed.Control))+
  scale_color_manual(values=c("black", "limegreen"))+
  facet_grid(.~Age)+
  theme_bw()

```

```{r po_plots, echo=FALSE}
po %>%
  ggplot()+
  geom_point(aes(x=Hours_from_Start, y =Corrected_Change, color=Time_treatment))+
  scale_color_manual(values=c("goldenrod2", "darkblue"))+
  geom_smooth(aes(x=Hours_from_Start, y =Corrected_Change), color="black", span=1)+
  theme_bw()

po_correct %>%
  ggplot() +
  geom_point(aes(x = time, y = PO, group = sample)) +
  geom_smooth(aes(x = time, y = PO), method = "lm") +
  theme_bw()
```

```{r growth_plots, echo=FALSE}
growth %>%
  filter(Age == 6) %>%
  ggplot(aes(x=days_post_exposure, y=Length_at_exposure_mm, color=as.factor(Animal)))+
  geom_point()+
  geom_line()+
  facet_grid(Time_treatment~.)

growth %>%
  filter(Age == 7) %>%
  ggplot(aes(x=days_post_exposure, y=Length_at_exposure_mm, color=as.factor(Animal)))+
  geom_point()+
  geom_line()+
  facet_grid(Time_treatment~.)

growth %>%
  filter(Age == 8) %>%
  ggplot(aes(x=days_post_exposure, y=Length_at_exposure_mm, color=as.factor(Animal)))+
  geom_point()+
  geom_line()+
  facet_grid(Time_treatment~.)

growth %>%
  filter(Age == 9) %>%
  ggplot(aes(x=days_post_exposure, y=Length_at_exposure_mm, color=as.factor(Animal)))+
  geom_point()+
  geom_line()+
  facet_grid(Time_treatment~.)

#lag and lead

```


```{r infection_plot, echo=FALSE}

# infection prevalence
all.data %>%
  filter(Time_treatment == "Exposed" | Sex == "F") %>%
  ggplot(aes(x=Age, y=infected, color=Time_treatment))+
  scale_color_manual(values=c("goldenrod2", "darkblue"))+
  geom_jitter(width = .1, height = .1)+
  geom_smooth(method="lm")+
  scale_y_continuous(limits=c(-.1,1))+
  scale_x_continuous(breaks=c(6,7,8,9))+
  theme_bw()


#infection intensity
life %>%
  filter(Time_treatment == "Exposed"| Sex == "F") %>%
  ggplot(aes(x=Age, y=spore_counts, color=Time_treatment))+
  scale_color_manual(values=c("goldenrod2", "darkblue"))+
  #geom_jitter(width=.25)+
  geom_point()+
  geom_smooth(method="lm")+
  theme_bw()

```


```{r offsrping_plots, echo=FALSE}

#total offspring
all.data %>%
  filter(Sex == "F") %>%
  #filter(infected != "NA") %>%     #removes controls
  ggplot(aes(x=Time_treatment, y=total_offspring, fill=as.factor(infected)))+
  geom_boxplot()+
  facet_grid(~Age)


#age at first clutch
all.data %>% 
  filter(Sex == "F") %>%
  #filter(infected != "NA") %>%     #removes controls
  ggplot(aes(x=Time_treatment, y=age_at_first_clutch, fill=as.factor(infected)))+
  geom_boxplot()+
  facet_grid(~Age)

```


#Stats

# PO
```{r po}

#Does PO differ across a day (Resting = Light hours, Active = dark hours) and across ages? 
summary(po_model<-glm(Corrected_Change ~ Phase*as.factor(Age), data=po))
plot(po_model)

newdata<-expand.grid(Phase=c("Active", "Resting"), Age = 6:9)
newdata$preds<-predict(po_model, newdata=newdata)

newdata %>%
  ggplot()+
  geom_line(aes(x=Age, y=preds, color=Phase))+
  geom_point(po, mapping=aes(x=Age, y=Corrected_Change, color=Phase), alpha = 0.5)
```

# infection



```{r infection_prevalence}
prev <- all.data %>%
  filter(Exposed.Control == "Exposed", 
         days_post_exposure == 0) %>%
  group_by(Age, Time_treatment) %>%
  summarise(inf = sum(infected, na.rm=T),
            n = n(),
            prev = inf/n)

prev %>% knitr::kable()

prev %>% ggplot() +
  geom_point(aes(x = Age, y = prev, col = Time_treatment)) +
  geom_line(aes(x = Age, y = prev, col = Time_treatment)) +
  ylim(0,1)
```

```{r}
# get subset for infection and spore count analysis
# arbitrarily choose 0 days post exposure since the data is duplicated for each days_post_exposure
reg_data <- filter(all.data, Exposed.Control == "Exposed", days_post_exposure == 0) 

# logistic regression
# model 1: Time_treatment only
inf_time <- glm(infected ~ Time_treatment, family = binomial , data = reg_data)
# model 2: common linear effect of age with Time_treatment specific intercepts
inf_main <- glm(infected ~ Age + Time_treatment, family = binomial, data = reg_data)
# model 3: Time_treatment specific intercept and slopes
inf_full_lin <- glm(infected ~ Age * Time_treatment, family = binomial, data = reg_data)
# model 4: full interaction model with age as categorical
inf_full_cat <- glm(infected ~ factor(Age) * Time_treatment, family = binomial , data = reg_data)

# 
summary(inf_time)
summary(inf_main)
summary(inf_full_lin)
summary(inf_full_cat)

# residual plots
plot(inf_time, 1)
plot(inf_main, 1)
plot(inf_full_lin, 1)
plot(inf_full_cat, 1)
```

Based on the sign of the coefficient for Time_treatment, all models agree that night-time exposure increases the probability of infection. The model with just time of exposure is pretty good compared to the others. Based on the likelihood ratio tests and AIC comparison below, I think that if we were going to choose one model that we should go with model 2 (infected ~ Age + time_treatment).

Note: We should try including age at death as a predictor of infection (if it makes sense, i.e., dying soon after exposure "censors" the infection outcome) or spore counts.

```{r}
# likelihood ratio test for significance of linear age term
# marginally significant
car::Anova(inf_main, test = "LR")

# likelihood ratio test for significance of exposure time specific effect of age
# Not significant
car::Anova(inf_full_lin, test = "LR")

```

```{r}
AIC(inf_time, inf_main, inf_full_lin, inf_full_cat) %>%
  mutate(deltaAIC = AIC - min(AIC)) %>% add_column(model = c("time", "Age + time", "Age*time", "factor(Age)*time"), .before = 1)
```


# spore intensity

```{r}
zero_summary <- 
  all.data %>% filter(Exposed.Control == "Exposed", days_post_exposure == 0) %>%
  group_by(Age, Time_treatment) %>%
  summarise(mean_spore_counts = mean(spore_counts, na.rm = TRUE),
            var_spore_counts = var(spore_counts, na.rm = TRUE),
            n_zeros = sum(spore_counts == 0, na.rm = TRUE),
            n_na = sum(is.na(spore_counts)),
            n_infected = sum(infected == 1, na.rm = TRUE),
            n_animals = n())
zero_summary %>% knitr::kable(digits = 2)
```

### Fit regular count models

```{r}
spore_pois <- glm(spore_counts ~ as.factor(Age) * Time_treatment, family = poisson(), data=reg_data)
spore_nb <- MASS::glm.nb(spore_counts ~ as.factor(Age) * Time_treatment,  data=reg_data)

summary(spore_pois)
summary(spore_nb)
```

Standard errors are huge. Due to excess zeros?

### zero-inflated and hurdle models

```{r}
library(pscl)
# poisson
hurdle_poisson_full <-   hurdle(spore_counts ~ as.factor(Age) * Time_treatment | as.factor(Age) + Time_treatment, 
       dist = "poisson", zero.dist = "binomial", data = reg_data)
zi_poisson_full <- zeroinfl(spore_counts ~ as.factor(Age) * Time_treatment | as.factor(Age) + Time_treatment, 
       dist = "poisson", link = "logit", data = reg_data)
hurdle_poisson_main <-   hurdle(spore_counts ~ as.factor(Age) + Time_treatment | as.factor(Age) + Time_treatment, 
       dist = "poisson", zero.dist = "binomial", data = reg_data)
zi_poisson_main <- zeroinfl(spore_counts ~ as.factor(Age) + Time_treatment | as.factor(Age) + Time_treatment, 
       dist = "poisson", link = "logit", data = reg_data)
# negative binomial
hurdle_nb_full <-   hurdle(spore_counts ~ as.factor(Age) * Time_treatment | as.factor(Age) + Time_treatment,
       dist = "negbin", zero.dist = "binomial", data = reg_data)
zi_nb_full <- zeroinfl(spore_counts ~ as.factor(Age) * Time_treatment | as.factor(Age) + Time_treatment,
       dist = "negbin", link = "logit", data = reg_data)
hurdle_nb_main <-   hurdle(spore_counts ~ as.factor(Age) + Time_treatment | as.factor(Age) + Time_treatment,
       dist = "negbin", zero.dist = "binomial", data = reg_data)
zi_nb_main <- zeroinfl(spore_counts ~ as.factor(Age) + Time_treatment | as.factor(Age) + Time_treatment,
       dist = "negbin", link = "logit", data = reg_data)
zi_nb_lin_age_int <- zeroinfl(spore_counts ~ Age * Time_treatment | as.factor(Age) + Time_treatment,
       dist = "negbin", link = "logit", data = reg_data)
zi_nb_lin_age_main <- zeroinfl(spore_counts ~ Age + Time_treatment | as.factor(Age) + Time_treatment,
       dist = "negbin", link = "logit", data = reg_data)
```

Full hurdle models are computationally singular.Probably due to separation. Do not consider those models further.

```{r}
# AIC(zi_poisson_full,hurdle_poisson_main,zi_poisson_main,
#     zi_nb_full,hurdle_nb_main,zi_nb_main) %>%
AIC(zi_nb_lin_age_int,
    zi_nb_lin_age_main) %>%

  mutate(deltaAIC = AIC - min(AIC))
```

Top 3 models all have (truncated) negative binomial count response. Zero-inflated and hurdle model about the same for main effects in count part and full interaction model for counts is also in the top.

```{r}
summary(zi_nb_full)
summary(zi_nb_main)
summary(hurdle_nb_main)
summary(zi_nb_lin_age_main)
```

```{r}
zero_summary$response <- predict(zi_nb_lin_age_main, newdata = zero_summary, type = "response")
zero_summary$count <- predict(zi_nb_lin_age_main, newdata = zero_summary, type = "count")
zero_summary$prob_zero <- predict(zi_nb_lin_age_main, newdata = zero_summary, type = "zero")

zero_summary %>% knitr::kable(digits = 2)
```


# zero-inflated model predictions

```{r}
zero_summary$zeros_zi_full <- predict(zi_nb_full, newdata = zero_summary,  type = "zero")

zero_summary %>% 
  mutate(zeros_zi_full = zeros_zi_full * n_animals) %>%
  select(Time_treatment, n_zeros, zeros_zi_full , n_infected)
```

