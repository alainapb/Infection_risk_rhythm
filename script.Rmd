---
title: "script"
author: "APB"
date: "4/30/2021"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(patchwork)

knitr::opts_chunk$set(echo = TRUE)
```


#Load/Clean data
```{r load_data, include=FALSE}
feed_data<-read.csv("data/feeding_data_3.28.21.csv", header=T)

po<-read.csv("data/4_Day_PO.csv", header = T) #Corrected_Change is the Active PO per sample (8 ind. per sample)

growth<-read.csv("data/growth_data_3.28.21.csv", header=T)

life<-read.csv("data/life_data_3.28.21.csv", header =T)

```


#Calculate feeding rates
```{r animal_feed_rates, include = FALSE}
#calculate the mean of the controls for each plate
summary_data <- feed_data %>%
  group_by(Plate_Control) %>%
  mutate(control_mean = mean(Control_Flour_Reading, na.rm = T)) %>%
  select(Plate_Control, control_mean) %>%
  distinct() %>% as.data.frame()

#remove extra row
summary_data  <- summary_data[!(summary_data$Plate_Control == ""),]

#match control mean with plate treatment
map = setNames(summary_data$control_mean,summary_data$Plate_Control)
feed_data$control_mean <- map[as.character(feed_data$Plate_Treatment)]

#volume, mL
v = 10

#time, hours
t = 9

##difference in feeding compared to control
k=feed_data$control_mean/feed_data$Flourometry_Reading

##calculate feeding rate (Sarnelle and Wilson)
feed_data$fr_sw <- log(k) * (v/t)

#calculate mean feeding rate per animal (keep rate > 0)
animal_mean <- feed_data %>%
  #keep fr_sw values > 0
  #filter(fr_sw > 0) %>% #this removes 64 animals...
  #group based on these variables
  group_by(Time_treatment, Age, Animal, Exposed.Control) %>%
  #means based on groups above
  summarise(fr_sw = mean(fr_sw, na.rm=TRUE))



```


#Exploratory Plots
```{r feeding_rate_plot, echo=FALSE}
animal_mean %>%
  ggplot()+
  geom_boxplot(aes(x=as.factor(Age), y=fr_sw, color=Time_treatment))+
  scale_color_manual(values=c("goldenrod2", "darkblue"))+
  facet_grid(.~Exposed.Control)+
  theme_bw()

```

```{r po_plots, echo=FALSE}
po %>%
  ggplot()+
  geom_point(aes(x=Hours_from_Start, y =Corrected_Change, color=Time_treatment))+
  scale_color_manual(values=c("goldenrod2", "darkblue"))+
  geom_smooth(aes(x=Hours_from_Start, y =Corrected_Change), color="black", span=1)+
  theme_bw()

po %>%
  ggplot(aes(x=Age, y = Corrected_Change, color=Phase))+
  geom_point()+
  geom_smooth(method="lm")

po %>%
  ggplot(aes(x=Age, y = Corrected_Change/8, color=Phase))+
  geom_point()+
  geom_smooth(method="lm")

```

```{r growth_plot, echo=FALSE}
growth %>%
  filter(Age == 7) %>%
  ggplot(aes(x=days_post_exposure, y=Length_at_exposure_mm, color=as.factor(Animal)))+
  geom_point()+
  geom_line()+
  facet_grid(Time_treatment~.)

#lag and lead

```


```{r infection_plot, echo=FALSE}

# infection prevalence
life %>%
  filter(Treatment == "Exposed") %>%
  ggplot(aes(x=Age_at_exposure, y=infected, color=Day.Night))+
  geom_jitter()+
  geom_smooth(method="lm")


#infection intensity
life %>%
  filter(Treatment == "Exposed") %>%
  ggplot(aes(x=Age_at_exposure, y=spore_counts, color=Day.Night))+
  geom_point()+
  geom_smooth(method="lm")

```

